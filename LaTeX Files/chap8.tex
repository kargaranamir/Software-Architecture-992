\chapter{معماری نمونه مطالعاتی تاکسی‌آنلاین \lr{Uber}}
\section{معماری میکرو‌سرویس دامنه‌گرا}
\label{section:domainmicroservice}
اوبر \LTRfootnote{Uber} دارای بیش از ۲۲۰۰ میکرو‌سرویس است\cite{microservice_uber} و وجود تعداد زیادی میکرو‌سرویس باعث پیدایش پیچیدگی زیادی در نگهداری این سرویس ها و توسعه سرویس‌های جدید می‌شود تا جایی که \lr{Uber} سعی کرد با تغییراتی در معماری میکرو‌سرویس، معماری میکروسرویس دامنه‌گرا\LTRfootnote{Domain-Oriented Microservice Architecture} را ارائه دهد؛ در معماری میکرو‌سرویس دامنه‌گرا سعی شده است تا با حفظ مزیت‌های معماری میکرو‌سرویس، از پیچیدگی کل سیستم کاسته شود.

در معماری میکروسرویس، سرویس‌ها با عملکرد محدود به یک حوزه بر روی یک شبکه مستقر می‌شوند و از طریق رابط های تعریف شده به درخواست‌های که به صورت \lr{Remote Procedure Call} ارسال می‌شوند پاسخ می‌دهند؛ اوبر به دلایل زیر در سال ۲۰۱۲ معماری خود را از \lr{monolithic} به \lr{micro-service} تغییر داد:
\begin{itemize}
\item
ریسک‌های دردسترس‌پذیری\LTRfootnote{Availability} : یک خطا در سیستم \lr{monolithic} می‌توانست منجر به از دست خارج‌شدن کل سیستم \lr{Uber} شود.
\item
استقرار\LTRfootnote{Deployment} های پرخطر و زمان‌بر
\item
تفکیک ضعیف نگرانی‌ها\LTRfootnote{Concerns} : با‌وجود یک پایگاه کد بزرگ تفکیک مرز میان منطق تجاری و مولفه‌ها در یک سیستم با رشد بسیار سریع به خوبی صورت نمی‌پذیرد.
\item
اجرای ناکارآمد : وجود مشکلاتی که به چندین تیم وابستگی دارد، سبب می‌شود تا کارایی در اجرا بسیار پایین باشد.
\end{itemize}

هر چند مهاجرت از سیستم با معماری \lr{monolithic} به \lr{microservice} در زمانی که اندازه شرکت اوبر به صد‌ها مهندس رسیده بود بسیاری از مشکلات را حل کرد، اما زمانی که تعداد میکرو‌سرویس‌ها افزایش یافت شرکت متوجه پیچیدگی روزافزون معماری میکروسرویس شد؛ به عنوان مثال گاهی نیاز است برای یافتن ریشه‌ی یک خطا چندین میکروسرویس از تیم‌های مختلف مورد بررسی قرار گیرند. همچنین وابستگی میان سرویس‌ها گاه سبب می‌شود تا تاخیر پاسخ یک سرویس دیگر قابل قبول نباشد.همان طور که از پیچیدگی شبکه \lr{Uber} در سال ۲۰۱۸ \ref{fig:microserice_network} مشخص است میکروسرویس ها شدیدا به یکدیگر وابسته هستند.
\begin{figure}[h]
\label{fig:microserice_network}
\centering
\includegraphics[width=8cm]{uber_service_network.png}
\end{figure}

به جهت پیاده‌سازی یک امکان جدید در \lr{Uber} یک تیم باید با سرویس‌‌های متفاوت متعلق به تیم‌های متفاوت کار کند و این عمل به جلسات زیادی بر روی طراحی و بازبینی کد نیاز دارد. همچنین مزیت معماری میکروسرویس در مورد داشتن خطوط مشخص مالکیت سرویس، هنگامی که تیم ها در سرویس های یکدیگر کد ایجاد می‌کنند، مدل‌های داده یکدیگر را اصلاح می کنند و حتی از طرف دارندگان سرویس نسخه‌های جدید را استقرار\LTRfootnote{deployment} می‌دهند، به خطر می افتد.در نتیجه با افزایش تعداد سرویس‌ها گویا با یک سیستم \lr{Network Monolithic} سر کار داریم که یکی از نتایج آن این است که چندین میکروسرویس به ظاهر مستقل نیاز دارند تا همزمان در سامانه مستقر شوند تا سامانه بدون نقص به عملکرد خود ادامه دهد.

در "معماری سرویس دامنه‌گرا" به طور عمده از روشهای تثبیت‌شده ساختار‌دهی کد مانند طراحی مبتنی بر دامنه \LTRfootnote{Domain-driven Design} \cite{evans2004domain}، معماری تمیز\LTRfootnote{Clean Architecture} \cite{martin2018clean}، معماری سرویس‌گرا\LTRfootnote{Service-Oriented Architecture} \cite{perrey2003service} و الگوهای طراحی شی‌گرا \LTRfootnote{object-oriented design} و رابطه گرا\LTRfootnote{interface-oriented design} استفاده می شود.

اصول اصلی و اصطلاحات مرتبط با معماری سرویس دامنه‌گرا به شرح زیر است:
\begin{itemize}
\item 
با تعریف \lr{Domain} به جای شکل گیری پیرامون یک به یک میکروسرویس‌ها، پیرامون مجموعه‌ای از میکروسرویس‌های مرتبط شکل گرفته است.
\item
معماری \lr{Uber} همچنین مجموعه دامنه هایی را ایجاد می‌کند که لایه نامیده می‌شوند. لایه‌ای که دامنه به آن تعلق دارد مشخص می کند که میکروسرویس‌های موجود در آن دامنه چه وابستگی هایی را دارند.
\item
معماری برای دامنه‌ها رابط هایی مشخص ارائه می‌دهد که به عنوان یک نقطه واحد ورود به مجموعه رفتار می‌کنند و به آن‌ها دروازه\LTRfootnote{gateway} گفته می‌شود.
\item
هر دامنه باید برای دامنه های دیگر ناشناخته باشد ، به عبارت دیگر ، یک دامنه نباید منطق مربوط به دامنه دیگری را داشته باشد که در داخل کد یا مدل داده‌‌ای دامنه دیگر وجود دارد. از آنجا که گاهی تیم ها نیاز دارند تا منطق را در دامنه تیم دیگری قرار دهند، ما یک معماری تکمیلی برای پشتیبانی از نقاط توسعه یافته تعریف شده در دامنه ارائه می دهیم.
\end{itemize}

دامنه‌ها به واسطه گردهمایی سرویس‌هایی که منطق تجاری مشابهی دارند، ایجاد می‌شوند و تعداد سرویس‌های درون یک دامنه متغیری است که دامنه‌ی گسترده‌ای دارد و دامنه ها می توانند شامل یک تا ده ها سرویس باشند؛ به عنوان مثال \lr{Uber Maps} به سه دامنه تقسیم می‌شود که این ۳ دامنه در مجموع ۸۰ میکروسرویس را در بر دارند و ۳ \lr{gateway} بر سر راه آن‌ها تعبیه شده است.

معماری \lr{Uber} برای پاسخ به این سوال که "چه سرویس‌هایی می‌توانند چه سرویس‌های دیگری را فراخوانی کنند" دست به ایجاد لایه‌ها در سطح معماری زده‌است.با وجود لایه‌های مختلف مدیریت وابستگی در مقیاس صورت می‌پذیرد و نگرانی‌های مختلف معماری در لایه‌‌های مختلف از یکدیگر تفکیک می‌شوند.به کمک لایه‌ها با در نظر گرفتن شعاع انفجار شکست\LTRfootnote{failure blast radius}  دامنه‌ها، دامنه‌هایی که در پایین هرم قرار می‌گیرند وابستگی‌‌های بیشتری داشته و مجموعه‌ی بزرگتری از عملکرد‌‌های تجاری را ارائه می‌دهند.شکل \ref{fig:layers} به خوبی ایده‌ی لایه‌بندی را نشان می‌دهد:

\begin{figure}[h]
\centering
\includegraphics[scale=0.5]{layers.png}
\caption{لایه ها}
\label{fig:layers}
\end{figure}

لایه‌های پایینی عملکرد‌هایی نظیر مدیریت حساب کاربران را پشتیبانی می‌کنند در حالی که در قله هرم به عملکرد‌های جزئی‌تر نظیر تجربه کاربری یک امکان در موبایل پرداخته می‌شود.امکانات ممکن است با پخته‌تر شد تعمیم داده شوند و به لایه‌های پایین تر هرم مهاجرت کنند.

شرکت \lr{Uber} از ۵ لایه‌ی زیر در معماری لایه‌های خود استفاده می‌کند:
\begin{itemize}
\item
لایه زیرساخت\LTRfootnote{Infrastructure Layer} : پاسخ سوالاتی که هر واحد مهندسی می‌تواند از آن استفاده کند نظیر فضای ذخیره‌سازی و شبکه در این لایه داده شده است.
\item
لایه تجاری\LTRfootnote{Business Layer} : عملکرد‌های تجاری که سازمان عبور می‌تواند استفاده کند اما منحصرا مربوط به یک محصول خاص نظیر \lr{Uber Ride} یا \lr{Uber Eat} نیستند در این لایه قرار می‌گیرد.
\item
لایه محصول \LTRfootnote{Product Layer} : عملکرد‌های تجاری که مربوط به یک محصول و خط کسب‌و‌کار است توسط این لایه تامین می‌شود اما این لایه نیاز های مختص به یک پلتفرم خاص را پیاده‌سازی نمی‌کند؛ به عنوان به مثال به نحوه پیاده سازی "درخواست سفر" در اپلیکیشن موبایل کاری ندارد.
\item
لایه نمایش \LTRfootnote{Presentaion layer} : نیاز‌های عملکردی که کاربران در زمان استفاده از یک برنامه و پلتفرم خاص نیاز دارند را برطرف می‌کند.
\item
لایه لبه \LTRfootnote{Edge Layer} : لایه لبه امکانات \lr{Uber} را به دنیای بیرون عرضه می‌کنند و اپلیکیشن‌های موبایل نیز از ویژگی‌های این لایه استفاده می‌کنند.
\end{itemize}

همان‌طور که مشاهده می‌شود هر چه به لایه‌های بالاتر می‌رویم میزان شعاع انفجار شکست کاهش می‌یابد و عملکرد دامنه‌ها خاص‌تر می‌شود.

دروازه‌های تعریف شده در معماری میکروسرویس دامنه‌گرا بجای اینکه به یک میکروسرویس مربوط باشد به مجموعه‌ای از میکروسرویس‌ها که ما از آن‌ها با نام دامنه یاد می‌کنیم مربوط هستند.شکل \ref{fig:gateways} به خوبی ارتباط را نمایش می‌دهد.‍

\begin{figure}[h]
\centering
\includegraphics[scale=0.5]{gateways.png}
\caption{دروازه ها}
\label{fig:gateways}
\end{figure}

اگر به معنای طراحی شی گرا به دروازه ها نگاه شود، دروازه‌ها در واقع تعاریف واسط هستند، که به ما امکان می دهد هر کاری را که می خواهیم از نظر "پیاده سازی" در پایگاه کد انجام دهیم.

\section{قابل مشاهده بودن در مقیاس بزرگ}
در هنگام تصور سازمانی به بزرگی \lr{Uber} یکی از نیاز‌های مهم قابلیت مشاهده و مانیتورینگ بسیاری از نیاز‌های کیفی همراه با رشد و گسترش سازمان است. برای حفظ ثبات در معماری میکروسرویس دامنه‌گرا که در بخش \cite{domainmicroservice} به آن اشاره شد تیم مشاهده\LTRfootnote{Obserability team} شرکت \lr{Uber} اقدام به ساخت خط لوله‌هایی به منظور تشخیص، هشدار و کاهش عواقب مشکلات در میکروسرویس‌های ساخته‌شده در تیم‌های مهندسی مختلف کرده‌است؛ به عنوان مثال دو نمونه از این خط لوله‌ها به جهت مراقبت از دیتاسنتر‌ها با نام‌های \lr{uMonitor} و \lr{Neris} ساخته شده اند.\lr{uMonitor} سیستم هشدار مبتنی بر معیار‌ها در \lr{Uber} است که بر اساس پلتفرم \lr{M2} \cite{m3_uber} مراکز داده را بررسی می‌کند، در حالی که \lr{Neris} در درجه اول به دنبال هشدارها در زیرساخت های سطح میزبان است.

\section{مدیریت منابع در \lr{Uber}}
یکی زیرساخت‌های نرم افزاری رایج در بین شرکتهای فناوری کلاستر\LTRfootnote{cluster} ها هستند.کلاستر مجموعه‌ای از منابع با میزبان‌های فیزیکی متفاوت است که با تبدیل به یک منبع مشترک منطقی در جهت تقویت توان محاسباتی و استفاده انعطاف پذیر از سخت افزار مراکز داده فعالیت می‌کند. در \lr{Uber}، مدیریت کلاسترها یک لایه انتزاعی برای کارهای مختلف فراهم می کند\cite{resource_uber}.

با افزایش گستره تجارت \lr{Uber} استفاده کارآمد از منابع کلاستر‌ها بسیار مهم می شود.پشته محاسباتی \lr{Uber} به دلیل وجود کلاستر های اختصاصی برای موارد استفاده دسته‌ای\LTRfootnote{Batch} ، باوضعیت\LTRfootnote{Stateful} و بی‌وضعیت\LTRfootnote{Stateless} به مدیریت ویژه‌ای نیازمند است و همچنین ماهیت دینامیک کسب‌و‌کار \lr{Uber} این مساله را سخت‌تر نیز می‌سازد؛ به عنوان مثال دامنه تقاضا برای سفرها با توجه به تعطیلات و ایام هفته بسیار متغیر است.هر چند \lr{Uber} سعی کرده است تا با فراهم آوردن سخت‌افزار بیش از حد نیاز تا جای ممکن در پاسخ به نیاز مشتریان کاستی نداشته باشد اما گاهی در هنگام اوج بار یک محصول و خط کسب‌و‌کار، درست در زمانی که بخشی از کلاستر‌ها اضافه بار دارند، کلاستر سایر محصولات ممکن است فضای خالی بدون استفاده داشته باشند و این تکیه بر کلاستر‌های اختصاصی نیز به این معنی است که  \lr{Uber} نمی‌تواند منابع محاسبه ای را بین آنها به اشتراک بگذارد.


برای استفاده بهتر از منابع،\lr{Uber} باید این بارهای کاری را در یک سیستم مدیریت بار واحد محاسبه کند. افزایش کارایی‌های حاصل باعث کاهش هزینه فنی هر سفر در زیرساخت های \lr{Uber} می‌شود و باعث افزاش حاشیه سود سفر‌ها در \lr{Uber} و درنهایت به نفع رانندگان و مسافران خواهد شد.

راه حلی که \lr{Uber} برای مدیریت کلاستر ها ارائه کرده است نرم‌افزار مدیریت یکپارچه کلاستر ها به نام \lr{Peloton} است\cite{resource_uber}؛ \lr{Peloton} یک برنامه‌ریز یکپارچه است که برای مدیریت منابع در بارهای متمایز طراحی شده است و مدیریت کلاستر ها در \lr{Uber} را تجمیع می‌کند. \lr{Peloton} با استفاده از یک پلتفرم مشترک، توازن در استفاده از منابع، به اشتراک گذاری گسترده منابع و پیش‌بینی استفاده از منابع برای نیازهای آینده در \lr{Uber} را پشتیبانی می‌کند.

از سایر محصولات مشابه با \lr{Peloton} می‌توان به \lr{Google Borg}\cite{verma2015large} ،\lr{kubernetes}\cite{kubernetes} ، \lr{Hadoop YARN}\cite{hadoop} و \lr{Apache Mesos/Aurora}\cite{aurora}\cite{mesos} اشاره کرد.












